import {Server} from "hapi"
import {addConnection, handleError, loadApps} from "app/helpers"
import config from "app/config"
import log from "app/log"

const server = new Server()

addConnection(server, ["admin"])

server.register([
  require("hapi-auth-cookie")
], error => {
  if (error) {
    handleError(error)
    return
  }
  server.auth.strategy("session", "cookie", "optional", {
    password: config.auth.cookiePassword,
    ttl: config.auth.sessionTimeout * 60 * 60 * 1000,
    isSecure: config.auth.isSecure,
    redirectTo: "/login",
    appendNext: true
  })
})

loadApps(server)

server.start(() => {
  server.connections.forEach(connection => {
    log.info({
      [connection.settings.labels[0]]: connection.info.uri
    })
  })
})
